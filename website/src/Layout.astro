---
import BaseLayout from "./BaseLayout.astro";
import ExternalLinks from "./components/ExternalLinks.astro";
import ActiveLink from "./components/ActiveLink.astro";
import navigation from "./navigation.json";
import {buildGetPages, buildTOC} from "./navigation-utils";

const {props} = Astro;
const {frontmatter = {}} = props;

const getPages = buildGetPages(await Astro.glob("./**/*.mdx"));
let sidebarEnabled = false;
let toc = "";

const allPages = getPages();
for (const page of allPages) {
  if (page.file === frontmatter.file) {
    toc = buildTOC(page);
    sidebarEnabled = toc !== "";
    break;
  }
}
---

<BaseLayout sidebarEnabled={sidebarEnabled} {...Astro.props}>
  <div class="docs-main">
    <aside class="docs-sidebar sidebar">
			<ul class="mobile-navigation">
				<li><a href="/">Docs</a></li>
				<li><a href={import.meta.env.PROD ? "https://play.rome.tools/" : "/playground"}>Playground</a></li>
				<li><ActiveLink href="/blog/">Blog</ActiveLink></li>
			</ul>

      <ExternalLinks />

      {navigation.order.map(id => {
        return <Fragment>
          <h2>{navigation.titles[id]}</h2>
    
          <ul class="navigation">
            {getPages(id).map((page) => {
              return <li><ActiveLink href={page.url}>{page.frontmatter.title}</ActiveLink></li>;
            })}
          </ul>
        </Fragment>;
      })}
    </aside>

    <main class={`main content ${frontmatter.mainClass ?? ""}`}>
      <slot />
    </main>

    {sidebarEnabled && <nav class="toc-sidebar sidebar">
      <h2>On this page</h2>
      <Fragment set:html={toc} />
    </nav>}
  </div>

  <footer aria-labelledby="footer">
    <div class="container footer-inner">
      <h1 id="footer" class="sr-only">Footer</h1>

      <p>&copy; 2022 Rome Tools. All rights reserved.</p>
    </div>
  </footer>
</BaseLayout>
