# Write tests for the formatter

We use [insta.rs](https://insta.rs/docs) for our snapshot tests, please make sure you read its documentation to learn the basics of snapshot testing.
You should install the companion [`cargo-insta`](https://insta.rs/docs/cli/) command to assist with snapshot reviewing.

Directories are divided by language, so when creating a new test file, make sure to have the correct file
under the correct folder:
- `JavaScript` => `js/` directory
- `TypeScript` => `ts/` directory
- `JSX` => `jsx/` directory
- `TSX` => `ts/` directory

To create a new snapshot test for JavaScript, create a new file to `crates/rome_js_formatter/tests/specs/js/`, e.g. `arrow_with_spaces.js`

```javascript
const foo     = ()    => {
	return bar
}
```

Files processed as modules must go inside the `module/` directory, files processed as script must go inside the
`script/` directory.

Run the following command to generate the new snapshot (the snapshot tests are generated by a procedure macro so we need to recompile the tests):

```bash
touch crates/rome_js_formatter/tests/spec_tests.rs && cargo test -p rome_js_formatter formatter
```

For better test driven development flow, start the formatter tests with [`cargo-watch`](https://crates.io/crates/cargo-watch):

```bash
cargo watch -i '*.new' -x 'test -p rome_js_formatter formatter'
```

After test execution, you will get a new `arrow.js.snap.new` file.

To actually update the snapshot, run `cargo insta review` to interactively review and accept the pending snapshot. `arrow.js.snap.new` will be replaced with `arrow.js.snap`

Sometimes, you need to verify the formatting for different cases/options. In order to do that, create a folder with
the cases you need to verify. If we needed to follow the previous example:

1. create a folder called `arrow_with_spaces/` and move the JS file there;
2. then create a file called `options.json`
3. The content would be something like:
    ```json
    {
        "cases": [
            {
                "line_width": 120,
                "indent_style": {"Space": 4}
            }
        ]
    }
    ````
4. the `cases` keyword is mandatory;
5. then each object of the array will contain the matrix of options you'd want to test.
   In this case the test suite will run a **second test case** with `line_width` to 120 and `ident_style` with  4 spaces
6. when the test suite is run, you will have two outputs in your snapshot: the default one and the custom one

## Identify issues

There are four cases when a test is not correct:
- you try to print/format the same token multiple times; the formatter will check at runtime when a test is run;
- some tokens haven't been printed; usually you will have this information inside the snapshot, under a section
called `"Unimplemeted tokens/nodes"`; a test, in order to be valid, can't have that section;

   If removing a token is the actual behaviour (removing some parenthesis or a semicolon), then the correct way 
   to do it by using the formatter API `formatter.format_replaced(token, empty_element())`;
- the emitted code is not a valid program anymore, the test suite will parse again the emitted code and it will
fail if there are syntax errors;
- the emitted code, when formatted again, differs from the original; this usually happens when removing/adding new
elements, and the grouping is not correctly set;